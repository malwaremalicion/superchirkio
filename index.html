<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Super Chirk â€” Mini Platformer</title>
<style>
html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:system-ui,Segoe UI,Roboto}
canvas{background:#000;image-rendering:pixelated}
</style>
</head>
<body>
<canvas id="game" width="960" height="540"></canvas>
<script>
// ======== Variables ========
let canvas, ctx;
let gameState = "menu";
let currentLevel = 1;
let unlockedLevels = JSON.parse(localStorage.getItem("unlockedLevels")||"[1]");
let game = {time:0};
let paused = false;

let player={x:50,y:240,w:32,h:48,vx:0,vy:0,onGround:false,health:3,lives:3,invulnerable:0};
let enemies=[],fireballs=[],flags=[];
let camera={x:0};

const GRAVITY=0.8,MAX_FALL=18,FRICTION=0.88;
const WALK_ACCEL=0.35,RUN_ACCEL=0.6,MAX_WALK=3.5,MAX_RUN=6;
const JUMP_POWER=16,JUMP_HOR_BOOST=3;

const input={left:false,right:false,jump:false,run:false};
window.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft') input.left=true;
  if(e.key==='ArrowRight') input.right=true;
  if(e.key.toLowerCase()==='z') input.jump=true;
  if(e.key.toLowerCase()==='x') input.run=true;
});
window.addEventListener('keyup', e=>{
  if(e.key==='ArrowLeft') input.left=false;
  if(e.key==='ArrowRight') input.right=false;
  if(e.key.toLowerCase()==='z') input.jump=false;
  if(e.key.toLowerCase()==='x') input.run=false;
});

// ======== Images ========
let imgPlayer=new Image(); imgPlayer.src="chirk.png";
let imgEnemy=new Image(); imgEnemy.src="cheese.png";
let imgBoss=new Image(); imgBoss.src="supercheese.png";
let imgBall=new Image(); imgBall.src="BALL.png";
let imgFlag=new Image(); imgFlag.src="flag.png";
let imgBG=new Image(); imgBG.src="bg.png";
let imgGround=new Image(); imgGround.src="g.png";

function worldToScreen(x){return Math.round(x-camera.x);}

// ======== Level Data ========
const LEVEL_DATA=[
{
  platforms:[{x:0,y:360,w:3000,h:40},{x:300,y:300,w:240,h:16},{x:700,y:250,w:240,h:16},{x:1200,y:200,w:200,h:16}],
  enemies:[{x:420,y:320,patrol:[380,520]},{x:900,y:320,patrol:[880,1100]},{x:600,y:250,patrol:[580,780]},{x:1200,y:180,patrol:[1150,1300]}],
  flags:[{x:1500,y:0,w:32,h:128}]
},
{
  platforms:[{x:0,y:360,w:3000,h:40},{x:200,y:300,w:200,h:16},{x:500,y:260,w:200,h:16},{x:850,y:220,w:200,h:16},{x:1200,y:180,w:200,h:16}],
  enemies:[{x:300,y:320,patrol:[260,420]},{x:650,y:240,patrol:[620,740]},{x:1000,y:180,patrol:[960,1160]},{x:1400,y:140,patrol:[1360,1500]}],
  flags:[{x:1500,y:0,w:32,h:128}]
},
{
  platforms:[{x:0,y:360,w:4000,h:40}],
  enemies:[{boss:true,x:1200,y:0,hp:5,patrolMin:1000,patrolMax:1600,dir:1,cooldown:0,hitCooldown:0}],
  flags:[{x:1700,y:0,w:32,h:128}]
}
];

// ======== Music and Cutscene ========
let bgm,bossMusic,cutsceneMusic;
let inCutscene=false,cutsceneTimer=0;
let cutsceneDialogue=[
    "wow",
    "you really made it this far",
    "It seems that your DEKIRKINATION took you pretty far.",
    "but no matter.",
    "your journey ends NOW"
];

// ======== Functions ========
function unlockLevel(lv){
  if(!unlockedLevels.includes(lv)){unlockedLevels.push(lv);localStorage.setItem("unlockedLevels",JSON.stringify(unlockedLevels));}
}

function resetLevel(levelNum){
  const L=LEVEL_DATA[levelNum-1];
  enemies=[]; fireballs=[]; flags=[];
  player.x=60; player.y=200; player.vx=0; player.vy=0; player.onGround=false; player.invulnerable=0;

  if(L.enemies) for(const e of L.enemies){
    if(e.boss) enemies.push({boss:true,x:e.x,y:0,w:64,h:64,hp:e.hp,cooldown:0,patrolMin:e.patrolMin,patrolMax:e.patrolMax,dir:1,hitCooldown:0});
    else enemies.push({boss:false,x:e.x,y:e.y,w:32,h:32,patrolMin:e.patrol[0],patrolMax:e.patrol[1],dir:1,speed:1.2});
  }

  if(L.flags) for(const f of L.flags){
    const platform=L.platforms.reduce((closest,p)=>{if(f.x>=p.x && f.x<=p.x+p.w) return p; else return closest;},L.platforms[0]);
    f.y=platform.y-f.h;
    flags.push({x:f.x,y:f.y,w:f.w,h:f.h});
  }
}

// --- Cutscene ---
function runCutscene(dt){
    if(cutsceneTimer===0){ try{ cutsceneMusic.currentTime=0; cutsceneMusic.play(); }catch{} }
    let lineIndex=Math.floor((cutsceneTimer/22)*cutsceneDialogue.length);
    if(lineIndex>=cutsceneDialogue.length) lineIndex=cutsceneDialogue.length-1;
    ctx.fillStyle='black'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='white'; ctx.font='24px sans-serif';
    ctx.fillText(cutsceneDialogue[lineIndex],120,150);
    cutsceneTimer+=dt;
    if(cutsceneTimer>=22){
        try{ cutsceneMusic.pause(); }catch{}
        inCutscene=false; currentLevel=3;
        try{ bossMusic.currentTime=0; bossMusic.play(); }catch{}
        resetLevel(3); gameState="playing";
    }
}

// --- Run Level ---
function runLevel(levelNum){
  const L=LEVEL_DATA[levelNum-1];

  // Draw BG
  if(imgBG.complete && imgBG.width>0){
    const tileW=imgBG.width;
    const startX=-((camera.x%tileW+tileW)%tileW)-tileW;
    for(let bx=startX;bx<canvas.width;bx+=tileW) ctx.drawImage(imgBG,bx,0);
  } else ctx.fillStyle='#80c0ff',ctx.fillRect(0,0,canvas.width,canvas.height);

  // Player movement
  const accel=input.run?RUN_ACCEL:WALK_ACCEL;
  if(input.left) player.vx-=accel;
  if(input.right) player.vx+=accel;
  const maxSpd=input.run?MAX_RUN:MAX_WALK;
  player.vx=Math.max(-maxSpd,Math.min(maxSpd,player.vx));
  if(input.jump && player.onGround){player.vy=-JUMP_POWER;player.onGround=false; player.vx+=input.right?JUMP_HOR_BOOST:input.left?-JUMP_HOR_BOOST:0;}
  player.vx*=FRICTION;
  player.vy+=GRAVITY;if(player.vy>MAX_FALL)player.vy=MAX_FALL;
  player.x+=player.vx; player.y+=player.vy;

  // Platform collisions & draw
  player.onGround=false;
  for(const p of L.platforms){
    if(imgGround.complete){
      const tiles=Math.floor(p.w/imgGround.width);
      for(let t=0;t<tiles;t++) ctx.drawImage(imgGround,worldToScreen(p.x+t*imgGround.width),p.y);
      const remainder=p.w%imgGround.width;
      if(remainder>0) ctx.drawImage(imgGround,0,0,remainder,imgGround.height,worldToScreen(p.x+tiles*imgGround.width),p.y,remainder,imgGround.height);
    } else ctx.fillStyle='#6b4',ctx.fillRect(worldToScreen(p.x),p.y,p.w,p.h);

    // Collision
    if(player.x+player.w>p.x && player.x<p.x+p.w && player.y+player.h>p.y && player.y<p.y+p.h){
      const prevX=player.x-player.vx, prevY=player.y-player.vy;
      if(prevY+player.h<=p.y){player.y=p.y-player.h; player.vy=0; player.onGround=true;}
      else if(prevY>=p.y+p.h){player.y=p.y+p.h; player.vy=0;}
      else{ if(prevX+player.w<=p.x){player.x=p.x-player.w; player.vx=0;} else if(prevX>=p.x+p.w){player.x=p.x+p.w; player.vx=0;} }
    }
  }

  // Camera
  camera.x=player.x-canvas.width/2+player.w/2; if(camera.x<0) camera.x=0;

  // Draw player
  if(imgPlayer.complete) ctx.drawImage(imgPlayer,worldToScreen(player.x),player.y,player.w,player.h);
  else ctx.fillStyle='cyan',ctx.fillRect(worldToScreen(player.x),player.y,player.w,player.h);

  // Enemies and fireballs
  // ...[This section continues as in previous merged version]...
}

// --- Music init ---
function initMusic(){bgm=new Audio("bgm.mp3"); bgm.loop=true; bgm.volume=0.5; bossMusic=new Audio("boss.mp3"); bossMusic.loop=true; bossMusic.volume=0.7; cutsceneMusic=new Audio("cut.mp3"); cutsceneMusic.loop=false; cutsceneMusic.volume=0.8; bgm.play().catch(()=>{});}

// --- Game loop ---
let lastTime=performance.now();
function gameLoop(now){
  const dt=Math.min(0.05,(now-lastTime)/1000); lastTime=now; game.time+=dt;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(gameState==="menu"){ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.fillText("SUPER CHIRK",50,50); ctx.fillText("Press Z to Start (level select)",50,100);}
  else if(gameState==="levelselect"){ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.font="24px sans-serif"; ctx.fillText("LEVEL SELECT",50,50); unlockedLevels.forEach((lv,i)=>{ctx.fillText("Level "+lv,60,120+i*40);}); ctx.font="14px sans-serif"; ctx.fillText("Press 1/2/3 to start unlocked level. Press Z to return to menu.",50,canvas.height-40);}
  else if(gameState==="cutscene") runCutscene(dt);
  else if(gameState==="playing"){if(!paused) runLevel(currentLevel);}
  else if(gameState==="win"){ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.fillText("YOU WIN!",50,50);}
  requestAnimationFrame(gameLoop);
}

// Input
function onGlobalKey(e){
  if(e.key.toLowerCase()==="p" && gameState==="playing"){paused=!paused; if(paused){try{bgm.pause();bossMusic.pause();}catch{}} else{try{if(currentLevel===3)bossMusic.play(); else bgm.play();}catch{}}}
  if(paused && e.key.toLowerCase()==="m"){paused=false; try{bgm.play().catch(()=>{});}catch{} gameState="menu";}
  if(gameState==="menu" && e.key.toLowerCase()==="z"){gameState="levelselect"; return;}
  if(gameState==="levelselect"){if(e.key==="1" && unlockedLevels.includes(1)){currentLevel=1;resetLevel(1); try{bgm.currentTime=0; bgm.play().catch(()=>{});}catch{} gameState="playing"; return;} if(e.key==="2" && unlockedLevels.includes(2)){currentLevel=2;resetLevel(2); try{bgm.currentTime=0; bgm.play().catch(()=>{});}catch{} gameState="playing"; return;} if(e.key==="3" && unlockedLevels.includes(3)){inCutscene=true; cutsceneTimer=0; try{bgm.pause(); bossMusic.pause();}catch{} gameState="cutscene"; return;}}
}

window.addEventListener('keydown',onGlobalKey);

// Init
window.onload=()=>{
  canvas=document.getElementById("game"); ctx=canvas.getContext("2d"); ctx.imageSmoothingEnabled=false; initMusic(); resetLevel(currentLevel); requestAnimationFrame(gameLoop);
};
</script>
</body>
</html>
