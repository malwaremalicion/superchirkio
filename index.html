<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Super Chirk — Mini Platformer</title>
<style>
html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:system-ui,Segoe UI,Roboto}
canvas{background:#000;image-rendering:pixelated}
#ui{position:fixed;left:12px;top:12px;color:#fff}
button{padding:8px 12px;margin:6px}
</style>
</head>
<body>
<canvas id="game" width="960" height="540"></canvas>
<div id="ui"></div>
<script>
// === Super Chirk — fully fixed and restored with improved boss AI ===
let canvas=null, ctx=null;
let gameState="menu", currentLevel=1;
let unlockedLevels=JSON.parse(localStorage.getItem("unlockedLevels")||"[1]");
let game={time:0};
let bgm=null, bossMusic=null, cutsceneMusic=null, paused=false;
let inCutscene=false, cutsceneTimer=0;
let cutsceneDialogue=["wow","you really made it this far","It seems that your DEKIRKINATION took you pretty far.","but no matter.","your journey ends NOW"];

function unlockLevel(lv){
    if(lv<=LEVEL_DATA.length && !unlockedLevels.includes(lv)){
        unlockedLevels.push(lv);
        localStorage.setItem("unlockedLevels",JSON.stringify(unlockedLevels));
    }
}

function drawLevelSelect(){
    ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="white"; ctx.font="24px sans-serif"; ctx.fillText("LEVEL SELECT",50,50);
    unlockedLevels.forEach((lv,i)=>ctx.fillText("Level "+lv,60,120+i*40));
    ctx.font="14px sans-serif";
    ctx.fillText("Press 1/2/3 to start unlocked level. Press Z to return to menu.",50,canvas.height-40);
}

// === Gameplay objects ===
let player={x:50,y:240,w:32,h:48,vx:0,vy:0,onGround:false,facing:1,health:3,lives:3,invulnerable:0};
let enemies=[], fireballs=[], flags=[], gravity=0.8, camera={x:0,y:0};
const input={left:false,right:false,jump:false,run:false};
const WALK_ACCEL=0.35, RUN_ACCEL=0.6, MAX_WALK=3.5, MAX_RUN=6, FRICTION=0.88, GRAVITY=0.8, MAX_FALL=18, JUMP_POWER=12, JUMP_HOR_BOOST=2.5;

// Input
window.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')input.left=true;if(e.key==='ArrowRight')input.right=true;if(e.key.toLowerCase()==='z')input.jump=true;if(e.key.toLowerCase()==='x')input.run=true;});
window.addEventListener('keyup',e=>{if(e.key==='ArrowLeft')input.left=false;if(e.key==='ArrowRight')input.right=false;if(e.key.toLowerCase()==='z')input.jump=false;if(e.key.toLowerCase()==='x')input.run=false;});

// Levels
const LEVEL_DATA=[
  {platforms:[{x:0,y:360,w:2000,h:40},{x:300,y:300,w:120,h:16},{x:600,y:250,w:120,h:16}], enemies:[{x:420,y:320,patrol:[380,520]}], flags:[{x:950,y:300,w:32,h:64}]},
  {platforms:[{x:0,y:360,w:2000,h:40},{x:180,y:300,w:140,h:16},{x:480,y:260,w:140,h:16},{x:780,y:220,w:140,h:16}], enemies:[{x:300,y:320,patrol:[260,420]},{x:650,y:240,patrol:[620,740]}], flags:[{x:950,y:200,w:32,h:64}]},
  {platforms:[{x:0,y:360,w:2000,h:40},{x:220,y:300,w:120,h:16},{x:480,y:260,w:120,h:16},{x:740,y:220,w:120,h:16}], enemies:[{boss:true,x:900,hp:5}], flags:[{x:900,w:32,h:128}]}
];

// Images
let imgPlayer=new Image(); imgPlayer.src="chirk.png";
let imgEnemy=new Image(); imgEnemy.src="cheese.png";
let imgBoss=new Image(); imgBoss.src="supercheese.png";
let imgBall=new Image(); imgBall.src="BALL.png";
let imgFlag=new Image(); imgFlag.src="flag.png";
let imgBG=new Image(); imgBG.src="bg.png";
let imgGround=new Image(); imgGround.src="g.png";

function worldToScreen(x){return Math.round(x-camera.x);}

// --- Level reset ---
function resetLevel(levelNum){
    const L=LEVEL_DATA[levelNum-1];
    enemies=[]; fireballs=[]; flags=[];
    player.x=60; player.y=200; player.vx=0; player.vy=0; player.onGround=false; player.invulnerable=0;

    // Enemies
    if(L.enemies) for(const e of L.enemies){
        if(e.boss){
            const ground=L.platforms[0];
            enemies.push({boss:true,x:e.x,y:ground.y-64,w:64,h:64,hp:e.hp,cooldown:0,dir:1,hitCooldown:0});
        } else {
            const plat=L.platforms.find(p=>e.x>=p.x && e.x<=p.x+p.w)||L.platforms[0];
            enemies.push({boss:false,x:e.x,y:plat.y-32,w:32,h:32,patrolMin:Math.max(e.patrol[0],plat.x),patrolMax:Math.min(e.patrol[1],plat.x+plat.w-32),dir:1,speed:1.2});
        }
    }

    // Flags
    if(L.flags) for(const f of L.flags){
        const plat=L.platforms.find(p=>f.x>=p.x && f.x<=p.x+p.w)||L.platforms[0];
        flags.push({x:f.x,y:plat.y-f.h,w:f.w,h:f.h,visible:levelNum!==3});
    }
}

// --- Game Loop ---
function runLevel(levelNum){
    const L=LEVEL_DATA[levelNum-1];
    // BG
    if(imgBG.complete){const tileW=imgBG.width; const startX=-((camera.x%tileW+tileW)%tileW)-tileW; for(let bx=startX;bx<canvas.width;bx+=tileW) ctx.drawImage(imgBG,bx,0);}else ctx.fillStyle='#80c0ff',ctx.fillRect(0,0,canvas.width,canvas.height);

    // Player movement
    const accel=input.run?RUN_ACCEL:WALK_ACCEL;
    if(input.left) player.vx-=accel;
    if(input.right) player.vx+=accel;
    const maxSpd=input.run?MAX_RUN:MAX_WALK;
    player.vx=Math.max(-maxSpd,Math.min(maxSpd,player.vx));
    if(input.jump && player.onGround){player.vy=-JUMP_POWER; player.onGround=false; player.vx+=input.right?JUMP_HOR_BOOST:input.left?-JUMP_HOR_BOOST:0;}
    player.vx*=FRICTION; player.vy+=GRAVITY; if(player.vy>MAX_FALL)player.vy=MAX_FALL;
    player.x+=player.vx; player.y+=player.vy;

    // Platform collision
    player.onGround=false;
    for(const p of L.platforms){
        if(player.x+player.w>p.x && player.x<p.x+p.w && player.y+player.h>p.y && player.y<p.y+p.h){
            const prevX=player.x-player.vx, prevY=player.y-player.vy;
            if(prevY+player.h<=p.y){player.y=p.y-player.h;player.vy=0;player.onGround=true;}
            else if(prevY>=p.y+p.h){player.y=p.y+p.h;player.vy=0;}
            else{if(prevX+player.w<=p.x){player.x=p.x-player.w;player.vx=0;}else if(prevX>=p.x+p.w){player.x=p.x+p.w;player.vx=0;}}
        }
    }

    // Camera
    camera.x=player.x-canvas.width/2+player.w/2; if(camera.x<0) camera.x=0;

    // Draw player
    if(imgPlayer.complete) ctx.drawImage(imgPlayer,worldToScreen(player.x),player.y,player.w,player.h); else ctx.fillStyle='cyan',ctx.fillRect(worldToScreen(player.x),player.y,player.w,player.h);

    // --- Enemies & Boss ---
    const enemiesAlive=enemies.filter(e=>!e.boss).length;
    for(const e of enemies){
        if(e.boss){
            // Boss patrol
            const ground=L.platforms[0];
            e.x += 1.5*e.dir;
            if(e.x<=ground.x || e.x+e.w>=ground.x+ground.w) e.dir*=-1;

            // Shoot fireballs
            if(e.cooldown<=0){
                const dirX=player.x+player.w/2-(e.x+e.w/2);
                const dirY=player.y+player.h/2-(e.y+e.h/2);
                const mag=Math.sqrt(dirX*dirX+dirY*dirY);
                fireballs.push({x:e.x+e.w/2, y:e.y+e.h/2, vx:dirX/mag*5, vy:dirY/mag*5, life:200});
                e.cooldown=60;
            } else e.cooldown--;

            // Draw boss
            if(imgBoss.complete) ctx.drawImage(imgBoss, worldToScreen(e.x), e.y, e.w, e.h); else ctx.fillStyle='purple',ctx.fillRect(worldToScreen(e.x), e.y, e.w, e.h);

            // Hit counter
            ctx.fillStyle='black'; ctx.font='20px sans-serif';
            ctx.fillText('Boss HP: '+e.hp, worldToScreen(e.x), e.y-10);

            // Stomp detection
            if(player.vy>0 && player.y+player.h<e.y+16 && player.x+player.w>e.x && player.x<e.x+e.w){
                if(e.hitCooldown<=0){e.hp--; e.hitCooldown=30; player.vy=-10; try{ new Audio('owe.mp3').play(); }catch{} if(e.hp<=0) flags.forEach(f=>f.visible=true);}
            }

            // Side collision damage
            if(player.invulnerable<=0 && player.x<e.x+e.w && player.x+player.w>e.x && player.y<e.y+e.h && player.y+player.h>e.y){
                player.health-=1; player.invulnerable=90; player.x=Math.max(10, player.x-60);
                try{ new Audio('ow.mp3').play(); }catch{}
                if(player.health<=0){player.lives--; if(player.lives<=0){gameState='levelselect'; player.lives=3; player.health=3; try{bossMusic.pause();}catch{}} else resetLevel(levelNum);}
            }

        } else {
            // Normal enemy movement & stomp detection
            e.x+=e.speed*e.dir;
            if(e.x<e.patrolMin) e.dir=1; if(e.x>e.patrolMax) e.dir=-1;
            if(imgEnemy.complete) ctx.drawImage(imgEnemy, worldToScreen(e.x), e.y, e.w, e.h); else ctx.fillStyle='red',ctx.fillRect(worldToScreen(e.x), e.y, e.w, e.h);

            // Stomp
            if(player.vy>0 && player.y+player.h<e.y+12 && player.x+player.w>e.x && player.x<e.x+e.w){enemies.splice(enemies.indexOf(e),1); player.vy=-8; try{ new Audio('owe.mp3').play(); }catch{} continue;}
            // Side collision
            if(player.invulnerable<=0 && player.x<e.x+e.w && player.x+player.w>e.x && player.y<e.y+e.h && player.y+player.h>e.y){
                player.health-=1; player.invulnerable=90; player.x=Math.max(10, player.x-40);
                try{ new Audio('ow.mp3').play(); }catch{}
                if(player.health<=0){player.lives--; if(player.lives<=0){gameState='levelselect'; player.lives=3; player.health=3;} else resetLevel(levelNum);}
            }
        }
    }

    // --- Fireballs ---
    for(let i=fireballs.length-1;i>=0;i--){
        const b=fireballs[i];
        b.x+=b.vx; b.y+=b.vy; b.life--;
        if(imgBall.complete) ctx.drawImage(imgBall, worldToScreen(b.x), b.y, 16, 16); else ctx.fillStyle='orange',ctx.fillRect(worldToScreen(b.x), b.y, 16, 16);

        if(player.invulnerable<=0 && player.x<b.x+16 && player.x+player.w>b.x && player.y<b.y+16 && player.y+player.h>b.y){
            player.health-=1; player.invulnerable=90; player.x=Math.max(10, player.x-60); try{ new Audio('ow.mp3').play(); }catch{}
            fireballs.splice(i,1);
            if(player.health<=0){player.lives--; if(player.lives<=0){gameState='levelselect'; player.lives=3; player.health=3; try{bossMusic.pause();}catch{}} else resetLevel(levelNum);}
        }

        if(b.life<=0) fireballs.splice(i,1);
    }

    // --- Flags ---
    for(const f of flags){
        if(!f.visible) continue;
        if(imgFlag.complete) ctx.drawImage(imgFlag, worldToScreen(f.x), f.y, f.w, f.h); else ctx.fillStyle='yellow',ctx.fillRect(worldToScreen(f.x), f.y, f.w, f.h);
        if(enemiesAlive===0 && player.x+player.w>f.x && player.x<f.x+f.w && player.y+player.h>f.y){
            if(levelNum+1<=LEVEL_DATA.length) unlockLevel(levelNum+1);
            resetLevel(levelNum+1<=LEVEL_DATA.length?levelNum+1:levelNum);
            gameState='levelselect';
        }
    }

    if(player.invulnerable>0) player.invulnerable--;

    // HUD
    ctx.fillStyle='black'; ctx.font='16px sans-serif';
    ctx.fillText('Level '+levelNum,10,20);
    ctx.fillText('Health: '+player.health+'  Lives: '+player.lives,10,40);
}

// --- Music ---
function initMusic(){
    bgm=new Audio("bgm.mp3"); bgm.loop=true; bgm.volume=0.5;
    bossMusic=new Audio("boss.mp3"); bossMusic.loop=true; bossMusic.volume=0.7;
    cutsceneMusic=new Audio("cut.mp3"); cutsceneMusic.loop=false; cutsceneMusic.volume=0.8;
    try{bgm.play().catch(()=>{});}catch{}
}

// --- Global key ---
function onGlobalKey(e){
    if(e.key.toLowerCase()==="p" && gameState==="playing"){paused=!paused;if(paused){try{bgm.pause(); bossMusic.pause();}catch{}}else{try{if(currentLevel===3)bossMusic.play();else bgm.play();}catch{}}}
    if(paused && e.key.toLowerCase()==="m"){paused=false; try{bgm.play().catch(()=>{});}catch{} gameState="menu";}
    if(gameState==="menu" && e.key.toLowerCase()==="z"){gameState="levelselect";return;}
    if(gameState==="levelselect"){
        if(e.key==="1" && unlockedLevels.includes(1)){currentLevel=1;resetLevel(1); try{bgm.currentTime=0;bgm.play().catch(()=>{});}catch{} gameState="playing"; return;}
        if(e.key==="2" && unlockedLevels.includes(2)){currentLevel=2;resetLevel(2); try{bgm.currentTime=0;bgm.play().catch(()=>{});}catch{} gameState="playing"; return;}
        if(e.key==="3" && unlockedLevels.includes(3)){inCutscene=true; cutsceneTimer=0; try{bgm.pause(); bossMusic.pause();}catch{} gameState="cutscene"; return;}
    }
}
window.addEventListener('keydown',onGlobalKey);

// --- Game loop ---
let lastTime=performance.now();
function gameLoop(now){
    const dt=Math.min(0.05,(now-lastTime)/1000); lastTime=now; game.time+=dt;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(gameState==="menu"){ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.fillText("SUPER CHIRK",50,50); ctx.fillText("Press Z to Start (level select)",50,100);}
    else if(gameState==="levelselect") drawLevelSelect();
    else if(gameState==="cutscene"){
        ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.font="24px sans-serif";
        if(cutsceneTimer===0){try{cutsceneMusic.currentTime=0;cutsceneMusic.play().catch(()=>{});}catch{}}
        let lineIndex=Math.floor((cutscene
        let lineIndex=Math.floor((cutsceneTimer/22)*cutsceneDialogue.length);
        if(lineIndex>=cutsceneDialogue.length) lineIndex=cutsceneDialogue.length-1;
        ctx.fillText(cutsceneDialogue[lineIndex], 120, 150);
        cutsceneTimer+=dt;
        if(cutsceneTimer>=22){
            try{cutsceneMusic.pause();}catch{}
            inCutscene=false;
            currentLevel=3;
            try{bossMusic.currentTime=0; bossMusic.play().catch(()=>{});}catch{}
            resetLevel(3);
            gameState="playing";
        }
    }
    else if(gameState==="playing"){
        if(!paused) runLevel(currentLevel);
        else{
            ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle='white'; ctx.font='32px sans-serif'; ctx.fillText('PAUSED',120,120);
            ctx.font='18px sans-serif'; ctx.fillText('Press P to Resume',110,170); ctx.fillText('Press M for Menu',110,200);
        }
    }
    else if(gameState==="win"){
        ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="white"; ctx.fillText("YOU WIN!",50,50);
        ctx.fillText("Game permanently locked.",50,100);
    }

    requestAnimationFrame(gameLoop);
}

// --- Initialize ---
window.onload=()=>{
    canvas=document.getElementById("game"); ctx=canvas.getContext("2d"); ctx.imageSmoothingEnabled=false;
    initMusic(); requestAnimationFrame(gameLoop);
};
</script>
</body>
</html>

