<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Super Chirk — Final Build</title>
<style>
    body { margin: 0; background: #000; color: white; font-family: sans-serif; }
    canvas { background: #88ccff; display: block; margin: auto; }
</style>
</head>
<body>
<canvas id="game" width="800" height="480"></canvas>

<script>
/* ============================================
   SUPER CHIRK — FINAL COMPLETE BUILD
   ============================================ */

/* --------------------------------------------
   GLOBALS
-------------------------------------------- */
let canvas, ctx;
let lastTime = 0;
let gameState = "menu";
let currentLevel = 1;
let unlockedLevels = [1];

let camera = { x: 0 };

const gravity = 0.7;

let player = {
    x: 100, y: 0,
    w: 32, h: 32,
    vx: 0, vy: 0,
    onGround: false,
    health: 3,
    lives: 3,
    invulnerable: 0,
};

let enemies = [];
let fireballs = [];
let flags = [];
let imagesLoaded = false;

let inCutscene = false;
let cutsceneTimer = 0;

let imgPlayer = new Image();
let imgEnemy = new Image();
let imgBoss  = new Image();
let imgGround= new Image();
let imgFlag  = new Image();
let imgBG    = new Image();
let imgBall  = new Image();

/* --------------------------------------------
   LOAD GRAPHICS
-------------------------------------------- */
imgPlayer.src = "player.png";
imgEnemy.src  = "enemy.png";
imgBoss.src   = "boss.png";
imgGround.src = "ground.png";
imgFlag.src   = "flag.png";
imgBG.src     = "bg.png";
imgBall.src   = "fireball.png";

imgBall.onload = () => imagesLoaded = true;

/* --------------------------------------------
   MUSIC
-------------------------------------------- */
let bgMusic, bossMusic, cutsceneMusic;
function initMusic() {
    bgMusic = new Audio("bgmusic.mp3");
    bgMusic.loop = true;

    bossMusic = new Audio("bossmusic.mp3");
    bossMusic.loop = true;

    cutsceneMusic = new Audio("cutscene.mp3");
    cutsceneMusic.loop = false;
}

/* --------------------------------------------
   LEVEL DATA
-------------------------------------------- */
const LEVEL_DATA = [
    {
        // LEVEL 1
        platforms: [
            {x:0, y:420, w:2000, h:60},
            {x:300, y:340, w:240, h:40},
            {x:700, y:300, w:240, h:40},
        ],
        enemies: [
            {x:350, y:300},
            {x:720, y:260},
        ],
        flags: [
            {x:1800, y:360, w:40, h:120}
        ]
    },
    {
        // LEVEL 2
        platforms: [
            {x:0, y:420, w:2200, h:60},
            {x:350, y:330, w:200, h:40},
            {x:900, y:260, w:200, h:40},
            {x:1400, y:320, w:200, h:40}
        ],
        enemies: [
            {x:380, y:290},
            {x:940, y:220},
            {x:1450, y:280}
        ],
        flags: [
            {x:2050, y:360, w:40, h:120}
        ]
    },
    {
        // LEVEL 3 (BOSS)
        platforms: [
            {x:0, y:420, w:2400, h:60}
        ],
        enemies: [
            {boss:true, x:1600, y:360, hp:5, cooldown:0, hitCooldown:0, dir:-1, w:70, h:70}
        ],
        flags: [] // appears only after boss dies
    }
];

/* --------------------------------------------
   INPUT
-------------------------------------------- */
let input = { left:false, right:false, jump:false, run:false };

document.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft" || e.key === "a") input.left = true;
    if (e.key === "ArrowRight"|| e.key === "d") input.right = true;
    if (e.key === "ArrowUp"   || e.key === "w" || e.key === " ") input.jump = true;
    if (e.key === "Shift") input.run = true;
});

document.addEventListener("keyup", e => {
    if (e.key === "ArrowLeft" || e.key === "a") input.left = false;
    if (e.key === "ArrowRight"|| e.key === "d") input.right = false;
    if (e.key === "ArrowUp"   || e.key === "w" || e.key === " ") input.jump = false;
    if (e.key === "Shift") input.run = false;
});

/* --------------------------------------------
   WORLD → SCREEN X
-------------------------------------------- */
function worldToScreen(x) {
    return x - camera.x;
}

/* --------------------------------------------
   RESET LEVEL
-------------------------------------------- */
function resetLevel(levelNum){
    const L = LEVEL_DATA[levelNum-1];

    player.x = 100;
    player.y = 100;
    player.vx = 0;
    player.vy = 0;
    player.health = 3;
    player.invulnerable = 0;

    enemies = [];
    fireballs = [];
    flags = [];

    for(const e of L.enemies){
        if(e.boss){
            enemies.push({
                boss:true, x:e.x, y:e.y, w:e.w||70, h:e.h||70,
                hp:e.hp, dir:e.dir, cooldown:0, hitCooldown:0
            });
        } else {
            enemies.push({
                boss:false,
                x:e.x, y:e.y, w:32, h:32,
                speed:1.0,
                dir:1,
                patrolMin:e.x-60,
                patrolMax:e.x+60
            });
        }
    }

    for(const f of L.flags){
        flags.push({...f});
    }

    camera.x = 0;

    if(levelNum === 3){
        try{ bgMusic.pause(); bossMusic.currentTime=0; bossMusic.play(); }catch{}
    } else {
        try{ bossMusic.pause(); bgMusic.currentTime=0; bgMusic.play(); }catch{}
    }
}

/* --------------------------------------------
   UNLOCK LEVEL
-------------------------------------------- */
function unlockLevel(n){
    if(!unlockedLevels.includes(n)) unlockedLevels.push(n);
}

/* --------------------------------------------
   CUTSCENE
-------------------------------------------- */
const cutsceneDialogue=[
    "Chirk enters the realm of the Gaslord...",
    "A terrible evil bubbles beneath the surface...",
    "Only one hero can stop the fumes...",
    "Prepare for the final confrontation!"
];

/* --------------------------------------------
   GAME LOOP
-------------------------------------------- */
function gameLoop(timestamp){
    const dt = Math.min((timestamp-lastTime)/16.67, 1);
    lastTime = timestamp;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(gameState==="menu") drawMenu();
    else if(gameState==="levelselect") drawLevelSelect();
    else if(gameState==="cutscene") runCutscene(dt);
    else if(gameState==="playing") runLevel(currentLevel);
    else if(gameState==="win") drawWin();

    requestAnimationFrame(gameLoop);
}

/* --------------------------------------------
   MENU
-------------------------------------------- */
function drawMenu(){
    ctx.fillStyle="white";
    ctx.font="32px sans-serif";
    ctx.fillText("SUPER CHIRK", 280, 160);
    ctx.font="20px sans-serif";
    ctx.fillText("Press SPACE to start", 300, 240);

    document.onkeydown = e =>{
        if(e.key===" "){
            gameState="levelselect";
        }
    }
}

/* --------------------------------------------
   LEVEL SELECT
-------------------------------------------- */
function drawLevelSelect(){
    ctx.fillStyle="white";
    ctx.font="28px sans-serif";
    ctx.fillText("SELECT LEVEL", 300, 80);

    ctx.font="20px sans-serif";
    ctx.fillText("Press 1 for Level 1", 300, 150);
    ctx.fillText("Press 2 for Level 2", 300, 190);
    ctx.fillText("Press 3 for Level 3 (Boss)", 300, 230);

    document.onkeydown = e =>{
        if(e.key==="1" && unlockedLevels.includes(1)){
            currentLevel=1; resetLevel(1); gameState="playing";
        }
        if(e.key==="2" && unlockedLevels.includes(2)){
            currentLevel=2; resetLevel(2); gameState="playing";
        }
        if(e.key==="3" && unlockedLevels.includes(3)){
            cutsceneTimer=0;
            inCutscene=true;
            try{ cutsceneMusic.currentTime=0; cutsceneMusic.play(); }catch{}
            gameState="cutscene";
        }
    }
}

/* --------------------------------------------
   CUTSCENE LOGIC
-------------------------------------------- */
function runCutscene(dt){
    ctx.fillStyle="black";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="white";
    ctx.font="22px sans-serif";

    const idx = Math.floor((cutsceneTimer/22)*cutsceneDialogue.length);
    const line = cutsceneDialogue[Math.min(idx, cutsceneDialogue.length-1)];

    ctx.fillText(line, 100, 220);

    cutsceneTimer += dt;

    if(cutsceneTimer >= 22){
        try{ cutsceneMusic.pause(); }catch{}
        inCutscene=false;
        currentLevel=3;
        resetLevel(3);
        gameState="playing";
    }
}

/* --------------------------------------------
   WIN SCREEN
-------------------------------------------- */
function drawWin(){
    ctx.fillStyle="white";
    ctx.font="40px sans-serif";
    ctx.fillText("YOU DEFEATED THE GASLORD!", 120, 200);

    ctx.font="20px sans-serif";
    ctx.fillText("Press SPACE to return to menu", 220, 260);

    document.onkeydown = e =>{
        if(e.key===" "){
            gameState="menu";
        }
    }
}

/* --------------------------------------------
   MAIN LEVEL LOGIC
-------------------------------------------- */
function runLevel(levelNum){
    const L=LEVEL_DATA[levelNum-1];

    /* BACKGROUND */
    if(imgBG.complete){
        const tileW = imgBG.width;
        let startX = -((camera.x % tileW) + tileW);
        for(let x=startX; x<canvas.width; x+=tileW){
            ctx.drawImage(imgBG, x, 0);
        }
    } else {
        ctx.fillStyle="#88c0ff";
        ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    /* PLAYER MOVEMENT */
    const accel = input.run ? 0.6 : 0.35;

    if(input.left)  player.vx -= accel;
    if(input.right) player.vx += accel;

    const maxSpd = input.run ? 6 : 3.5;
    player.vx = Math.max(-maxSpd, Math.min(maxSpd, player.vx));

    if(input.jump && player.onGround){
        player.vy = -16; // HIGHER JUMP (A)
        player.onGround = false;
        if(input.right) player.vx += 2.5;
        else if(input.left) player.vx -= 2.5;
    }

    player.vx *= 0.88;
    player.vy += gravity;
    if(player.vy > 18) player.vy = 18;

    player.x += player.vx;
    player.y += player.vy;

    /* PLATFORM COLLISION */
    player.onGround = false;
    for(const p of L.platforms){
        if(player.x+player.w>p.x && player.x<p.x+p.w &&
           player.y+player.h>p.y && player.y<p.y+p.h)
        {
            const px = player.x - player.vx;
            const py = player.y - player.vy;

            if(py + player.h <= p.y){
                player.y = p.y - player.h;
                player.vy = 0;
                player.onGround = true;
            }
            else if(py >= p.y+p.h){
                player.y = p.y+p.h;
                player.vy = 0;
            }
            else {
                if(px + player.w <= p.x){
                    player.x = p.x - player.w;
                    player.vx = 0;
                }
                else if(px >= p.x+p.w){
                    player.x = p.x+p.w;
                    player.vx = 0;
                }
            }
        }
    }

    /* CAMERA */
    camera.x = player.x - canvas.width/2 + player.w/2;
    if(camera.x < 0) camera.x = 0;

    /* DRAW PLATFORMS */
    for(const p of L.platforms){
        if(imgGround.complete){
            for(let x=p.x; x<p.x+p.w; x+=imgGround.width){
                ctx.drawImage(imgGround, worldToScreen(x), p.y, imgGround.width, p.h);
            }
        } else {
            ctx.fillStyle="#6b4";
            ctx.fillRect(worldToScreen(p.x), p.y, p.w, p.h);
        }
    }

    /* DRAW PLAYER */
    if(imgPlayer.complete)
        ctx.drawImage(imgPlayer, worldToScreen(player.x), player.y, player.w, player.h);
    else
        ctx.fillStyle="cyan", ctx.fillRect(worldToScreen(player.x), player.y, player.w, player.h);

    /* ENEMIES */
    for(let i=enemies.length-1;i>=0;i--){
        const e = enemies[i];

        if(e.boss){
            // --- BOSS LOGIC ---
            e.x += e.dir * 1.4;
            const ground = L.platforms[0];
            if(e.x < 200){ e.dir=1; e.x=200; }
            if(e.x > ground.w - 200){ e.dir=-1; e.x=ground.w-200; }

            // Fireballs
            if(e.cooldown <= 0){
                const dx = (player.x+player.w/2) - (e.x+e.w/2);
                const dy = (player.y+player.h/2) - (e.y+e.h/2);
                const dist = Math.sqrt(dx*dx + dy*dy);
                const spd = 5;
                fireballs.push({
                    x:e.x+e.w/2,
                    y:e.y+e.h/2,
                    vx:dx/dist*spd,
                    vy:dy/dist*spd,
                    life:200
                });
                e.cooldown = 50;
            }
            e.cooldown--;

            // Draw boss
            if(imgBoss.complete)
                ctx.drawImage(imgBoss, worldToScreen(e.x), e.y, e.w, e.h);
            else
                ctx.fillStyle="purple", ctx.fillRect(worldToScreen(e.x), e.y, e.w, e.h);

            // Boss HP text
            ctx.fillStyle="black";
            ctx.font="16px sans-serif";
            ctx.fillText("Boss HP: " + e.hp, worldToScreen(e.x), e.y - 10);

            // --- BOSS STOMP FIX (WIN TRIGGER) ---
            if(
                player.vy > 0 &&
                player.y + player.h < e.y + 20 &&
                player.x + player.w > e.x &&
                player.x < e.x + e.w &&
                e.hitCooldown <= 0
            ){
                e.hp--;
                e.hitCooldown = 20;
                player.vy = -10;

                try{ new Audio("owe.mp3").play(); }catch{}

                if(e.hp <= 0){
                    try{ bossMusic.pause(); bossMusic.currentTime=0; }catch{}
                    enemies = [];
                    fireballs = [];
                    player.vx = 0;
                    player.vy = 0;
                    gameState = "win";
                    return;
                }
            }

            if(e.hitCooldown > 0) e.hitCooldown--;

        } else {
            // --- NORMAL ENEMY ---
            e.x += e.speed * e.dir;

            if(e.x < e.patrolMin){ e.dir = 1; e.x = e.patrolMin; }
            if(e.x > e.patrolMax){ e.dir = -1; e.x = e.patrolMax; }

            if(imgEnemy.complete)
                ctx.drawImage(imgEnemy, worldToScreen(e.x), e.y, e.w, e.h);
            else
                ctx.fillStyle="red", ctx.fillRect(worldToScreen(e.x), e.y, e.w, e.h);
        }
    }

    /* FIREBALLS */
    for(let i=fireballs.length-1;i>=0;i--){
        const b = fireballs[i];
        b.x += b.vx;
        b.y += b.vy;
        b.life--;

        if(imgBall.complete)
            ctx.drawImage(imgBall, worldToScreen(b.x), b.y, 16, 16);
        else
            ctx.fillStyle="orange", ctx.fillRect(worldToScreen(b.x), b.y, 16, 16);

        // Player hit
        if(
            player.invulnerable<=0 &&
            player.x < b.x+16 &&
            player.x+player.w > b.x &&
            player.y < b.y+16 &&
            player.y+player.h > b.y
        ){
            player.health--;
            player.invulnerable = 90;
            player.x = Math.max(10, player.x - 60);

            try{ new Audio("ow.mp3").play(); }catch{}

            fireballs.splice(i,1);

            if(player.health <= 0){
                player.lives--;
                if(player.lives <= 0){
                    gameState="levelselect";
                    player.lives = 3;
                    player.health = 3;
                    try{ bossMusic.pause(); }catch{}
                } else resetLevel(levelNum);
            }
        }

        if(b.life <= 0) fireballs.splice(i,1);
    }

    /* NORMAL ENEMY COLLISIONS */
    for(let i=enemies.length-1;i>=0;i--){
        const e = enemies[i];
        if(e.boss) continue;

        // stomp
        if(
            player.vy>0 &&
            player.y+player.h < e.y+15 &&
            player.x+player.w > e.x &&
            player.x < e.x+e.w
        ){
            enemies.splice(i,1);
            player.vy = -8;
            try{ new Audio("owe.mp3").play(); }catch{}
            continue;
        }

        // side hit
        if(
            player.invulnerable<=0 &&
            player.x < e.x+e.w && player.x+player.w > e.x &&
            player.y < e.y+e.h && player.y+player.h > e.y
        ){
            player.health--;
            player.invulnerable = 90;
            player.x = Math.max(10, player.x - 40);
            try{ new Audio("ow.mp3").play(); }catch{}

            if(player.health <= 0){
                player.lives--;
                if(player.lives <= 0){
                    gameState="levelselect";
                    player.lives=3;
                    player.health=3;
                    try{ bossMusic.pause(); }catch{}
                } else resetLevel(levelNum);
            }
        }
    }

    /* FLAGS — only active when all non-boss enemies are dead */
    const allEnemiesDead = enemies.filter(e=>!e.boss).length === 0;

    for(const f of flags){
        if(imgFlag.complete)
            ctx.drawImage(imgFlag, worldToScreen(f.x), f.y, f.w, f.h);
        else
            ctx.fillStyle="yellow", ctx.fillRect(worldToScreen(f.x), f.y, f.w, f.h);

        if(allEnemiesDead &&
           player.x + player.w > f.x &&
           player.x < f.x + f.w &&
           player.y + player.h > f.y)
        {
            unlockLevel(levelNum+1);
            currentLevel = levelNum + 1;
            if(levelNum+1 <= LEVEL_DATA.length){
                resetLevel(levelNum+1);
            }
            gameState="levelselect";
        }
    }

    /* INVULNERABILITY TIMER */
    if(player.invulnerable > 0) player.invulnerable--;

    /* HUD */
    ctx.fillStyle="black";
    ctx.font="16px sans-serif";
    ctx.fillText("Level " + levelNum, 10, 20);
    ctx.fillText("Health: " + player.health + " Lives: " + player.lives, 10, 40);
}

/* --------------------------------------------
   GLOBAL KEY ACTIONS
-------------------------------------------- */
function onGlobalKey(e){
    if(gameState==="playing"){
        if(e.key.toLowerCase()==="z"){
            gameState="menu";
            return;
        }
    }
}
window.addEventListener("keydown", onGlobalKey);

/* --------------------------------------------
   INIT
-------------------------------------------- */
window.onload = () => {
    canvas = document.getElementById("game");
    ctx = canvas.getContext("2d");
    initMusic();
    requestAnimationFrame(gameLoop);
};
</script>
</body>
</html>


